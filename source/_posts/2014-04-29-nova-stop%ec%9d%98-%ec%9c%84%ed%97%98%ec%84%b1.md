---
id: 1501
title: 'nova stop의 위험성...'
author: whitekid
layout: post
guid: http://blog.woosum.net/?p=1501
permalink: /archives/1501
dsq_thread_id:
  - 2646946990
categories:
  - Uncategorized
tags:
  - migrate
  - nova
  - OpenStack
  - resize
---
nova stop 명령은 당연히도 인스턴스를 shutdown하는 명령입니다. 근데 여기에는 약간은 당황스런 이슈가 숨어있군요.

nova stop은 결국은 libvirt.destroy()를 호출하게 되는데 여기에는 아래와 같은 코멘트가 있습니다.

> already and all resources used by it are given back to the hypervisor. This  
> does not free the associated virDomainPtr object.  
> This function may require privileged access.
> 
> virDomainDestroy first requests that a guest terminate  
> (e.g. SIGTERM), then waits for it to comply. After a reasonable  
> timeout, if the guest still exists, virDomainDestroy will  
> forcefully terminate the guest (e.g. SIGKILL) if necessary (which  
> may produce undesirable results, for example unflushed disk cache  
> in the guest). To avoid this possibility, it's recommended to  
> instead call virDomainDestroyFlags, sending the  
> VIR\_DOMAIN\_DESTROY_GRACEFUL flag.

If the domain is transient and has any snapshot metadata (see  
virDomainSnapshotNum()), then that metadata will automatically  
be deleted when the domain quits.

SIGTERM으로 인스턴스에 죽으라는 시그널을 날려주고, 적당한 시간 이후에도 인스턴스가 그대로 살아있을 경우는 SIGKILL로 인스턴스를 강제로 죽입니다. 그런데 이 경우 unflush된 디스크 캐쉬가 발생할 수 있다는 내용이죠.. 이를 피하기 위해서는 virDomainDestroyFlags로 VIR\_DOMAIN\_DESTORY_GRACEFUL 플레그를 설정하라고 되어있습니다.

nova.virt.driver.ComputeDriver.destroy()를 사용하는 명령, stop, migrate, resize 등은 이러한 위험성을 내포하고 있지요.

이러한 문제를 해결하기 위한 버그는 [Stop and Delete operations should give the Guest a chance to shutdown 등록][1]되어 있구요.. 하지만 icehouse에는 포함되지 않은 상태입니다.

disk i/o가 많은 인스턴스를 migrate, resize하는 경우 주의가 필요합니다.

 [1]: https://bugs.launchpad.net/nova/+bug/1196924